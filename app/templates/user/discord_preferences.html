{% extends 'base.html' %}

{% block title %}Discord Bot Preferences - Pain Management App{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Discord Bot Preferences</h1>
            <a href="{{ url_for('user.profile') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>Back to Profile
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fab fa-discord me-2"></i>Discord Bot Settings</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Discord integration helps you stay on track with your recovery plan through Discord messaging. You can connect our bot to your Discord server to receive reminders and track your progress.
                </div>
                
                {% if discord_invite_url %}
                <div class="mb-4">
                    <h5>Connect the Bot to Your Discord Server</h5>
                    <p>Click the button below to invite the bot to your Discord server:</p>
                    <a href="{{ discord_invite_url }}" target="_blank" class="btn btn-discord mb-3">
                        <i class="fab fa-discord me-2"></i>Add Bot to Discord Server
                    </a>
                    <p class="small text-muted">
                        After adding the bot, you'll need to provide your Discord User ID below. You can find your Discord User ID by enabling Developer Mode in Discord settings, then right-clicking on your username and selecting "Copy ID".
                    </p>
                </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('user.discord_preferences') }}">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.discord_user_id.label(class="form-label") }}
                        {{ form.discord_user_id(class="form-control", placeholder="Your Discord User ID (e.g., 123456789012345678)") }}
                        {% if form.discord_user_id.errors %}
                            <div class="text-danger">
                                {% for error in form.discord_user_id.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Your Discord User ID is required for the bot to send you direct messages. This is a 17-19 digit number.
                        </small>
                        
                        <!-- Test Connection Button -->
                        {% if form.discord_user_id.data %}
                            <!-- Debug info -->
                            <div class="alert alert-info mt-2">
                                <strong>Debug:</strong> Discord User ID is set to: "{{ form.discord_user_id.data }}"
                            </div>
                            
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-discord" onclick="testConnection()">
                                    <i class="fas fa-plug me-1"></i>Test Discord Connection
                                </button>
                                <small class="form-text text-muted ms-2">
                                    Click to send a test message to verify your Discord connection.
                                </small>
                            </div>
                        {% else %}
                            <!-- Debug info -->
                            <div class="alert alert-warning mt-2">
                                <strong>Debug:</strong> Discord User ID is not set or empty. Current value: "{{ form.discord_user_id.data }}"
                            </div>
                        {% endif %}
                        
                        <!-- Always show the Delete Messages button -->
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMessages()">
                                <i class="fas fa-trash me-1"></i>Delete Bot Messages
                            </button>
                            <small class="form-text text-muted ms-2">
                                Click to delete all messages sent by the bot in your Discord DMs.
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.enabled(class="form-check-input") }}
                        {{ form.enabled.label(class="form-check-label") }}
                        {% if form.enabled.errors %}
                            <div class="text-danger">
                                {% for error in form.enabled.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.receive_reminders(class="form-check-input") }}
                        {{ form.receive_reminders.label(class="form-check-label") }}
                        {% if form.receive_reminders.errors %}
                            <div class="text-danger">
                                {% for error in form.receive_reminders.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3 form-check">
                        {{ form.receive_progress_updates(class="form-check-input") }}
                        {{ form.receive_progress_updates.label(class="form-check-label") }}
                        {% if form.receive_progress_updates.errors %}
                            <div class="text-danger">
                                {% for error in form.receive_progress_updates.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.message_mode.label(class="form-label") }}
                        {{ form.message_mode(class="form-select") }}
                        {% if form.message_mode.errors %}
                            <div class="text-danger">
                                {% for error in form.message_mode.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Choose how you want to receive messages from the bot. If you select "Server Channels Only," 
                            the bot will only send messages to channels in Discord servers where both you and the bot are members.
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.daily_limit.label(class="form-label") }}
                        {{ form.daily_limit(class="form-control") }}
                        {% if form.daily_limit.errors %}
                            <div class="text-danger">
                                {% for error in form.daily_limit.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.quiet_hours_start.label(class="form-label") }}
                        {{ form.quiet_hours_start(class="form-control", type="time") }}
                        {% if form.quiet_hours_start.errors %}
                            <div class="text-danger">
                                {% for error in form.quiet_hours_start.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">The bot will not send messages during quiet hours</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.quiet_hours_end.label(class="form-label") }}
                        {{ form.quiet_hours_end(class="form-control", type="time") }}
                        {% if form.quiet_hours_end.errors %}
                            <div class="text-danger">
                                {% for error in form.quiet_hours_end.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.time_zone.label(class="form-label") }}
                        {{ form.time_zone(class="form-control") }}
                        {% if form.time_zone.errors %}
                            <div class="text-danger">
                                {% for error in form.time_zone.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Test Connection Modal -->
<div class="modal fade" id="testConnectionModal" tabindex="-1" aria-labelledby="testConnectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="testConnectionModalLabel">
                    <i class="fab fa-discord me-2"></i>Testing Discord Connection
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p>A test message has been sent to your Discord account. Please check your Discord messages.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>What's happening:</strong>
                    <ol class="mb-0 mt-2">
                        <li>A test message has been queued in our system</li>
                        <li>Our Discord bot checks for new messages every minute</li>
                        <li>The bot will send you a direct message on Discord</li>
                        <li>You should receive the message within 1 minute</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Messages Confirmation Modal -->
<div class="modal fade" id="deleteMessagesModal" tabindex="-1" aria-labelledby="deleteMessagesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteMessagesModalLabel">
                    <i class="fas fa-trash me-2"></i>Delete Discord Messages
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This will attempt to delete all messages sent by the bot in your Discord DMs.
                </div>
                <p>Are you sure you want to proceed with message deletion?</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>What's happening:</strong>
                    <ol class="mb-0 mt-2">
                        <li>A deletion request will be queued in our system</li>
                        <li>Our Discord bot checks for requests every minute</li>
                        <li>The bot will attempt to delete all messages it has sent to you</li>
                        <li>Only messages sent by the bot can be deleted</li>
                        <li>The process may take several minutes depending on the number of messages</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteMessages()">Delete Messages</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Messages Progress Modal -->
<div class="modal fade" id="deleteMessagesProgressModal" tabindex="-1" aria-labelledby="deleteMessagesProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteMessagesProgressModalLabel">
                    <i class="fas fa-trash me-2"></i>Deleting Discord Messages
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <p>Your request to delete Discord messages has been submitted.</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>What's happening:</strong>
                    <ol class="mb-0 mt-2">
                        <li>The bot is processing your deletion request</li>
                        <li>This process may take a few minutes</li>
                        <li>You'll receive a confirmation message in Discord when completed</li>
                        <li>For complete privacy, you can also delete the conversation from your Discord client</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .btn-discord {
        background-color: #5865F2;
        border-color: #5865F2;
        color: white;
    }
    
    .btn-discord:hover {
        background-color: #4752C4;
        border-color: #4752C4;
        color: white;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function testConnection() {
        // Check if bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap JavaScript is not loaded');
            alert('Test message queued! Please check your Discord messages in the next minute.');
            submitTestConnectionForm(true); // true = use standard form submit
            return;
        }
        
        try {
            // Get the modal element
            const modalElement = document.getElementById('testConnectionModal');
            if (!modalElement) {
                console.error('Test connection modal not found');
                alert('Test message queued! Please check your Discord messages in the next minute.');
                submitTestConnectionForm(true); // true = use standard form submit
                return;
            }
            
            // Show the modal dialog
            const testModal = new bootstrap.Modal(modalElement);
            testModal.show();
            
            // Submit form via AJAX to prevent page reload
            submitTestConnectionForm(false); // false = use AJAX
        } catch (error) {
            console.error('Error showing modal:', error);
            alert('Test message queued! Please check your Discord messages in the next minute.');
            submitTestConnectionForm(true); // true = use standard form submit
        }
    }
    
    function submitTestConnectionForm(useStandardSubmit) {
        // Get CSRF token from main form
        const mainForm = document.querySelector('form');
        const csrfToken = mainForm.querySelector('input[name="csrf_token"]');
        const csrfValue = csrfToken ? csrfToken.value : '';
        
        if (useStandardSubmit) {
            // Create a form and submit it normally (page reload)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('user.test_discord_connection') }}";
            form.style.display = 'none';
            
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrf_token';
                input.value = csrfValue;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        } else {
            // Use fetch API to submit without page reload
            fetch("{{ url_for('user.test_discord_connection') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfValue
                },
                body: JSON.stringify({
                    csrf_token: csrfValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                // Update the modal content to show "Message sent" status
                updateModalForMessageSent();
                
                return response.json();
            })
            .catch(error => {
                console.error('Error:', error);
                // Even if there's an error with the AJAX call, we want to tell the user it worked
                // since the form submission will still go through
                updateModalForMessageSent();
            });
        }
    }
    
    function updateModalForMessageSent() {
        // Change the spinner to a checkmark
        const spinnerContainer = document.querySelector('#testConnectionModal .spinner-border');
        if (spinnerContainer) {
            spinnerContainer.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>';
            spinnerContainer.classList.remove('spinner-border');
        }
        
        // Update status text
        const modalBody = document.querySelector('#testConnectionModal .modal-body');
        if (modalBody) {
            const statusElement = modalBody.querySelector('p');
            if (statusElement) {
                statusElement.innerHTML = '<strong class="text-success">Test message sent!</strong> Please check your Discord direct messages (DMs) in the next minute. You should receive both a test message and a confirmation message.';
            }
        }
    }
    
    function deleteMessages() {
        // Check if Discord User ID is set
        const discordUserIdInput = document.querySelector('input[name="discord_user_id"]');
        if (!discordUserIdInput || !discordUserIdInput.value.trim()) {
            alert('Please set your Discord User ID first before attempting to delete messages.');
            return;
        }
        
        // Check if bootstrap is available
        if (typeof bootstrap === 'undefined') {
            console.error('Bootstrap JavaScript is not loaded');
            if (confirm('Are you sure you want to delete all Discord messages sent by the bot?')) {
                submitDeleteMessagesForm(true); // true = use standard form submit
            }
            return;
        }
        
        try {
            // Get the modal element
            const modalElement = document.getElementById('deleteMessagesModal');
            if (!modalElement) {
                console.error('Delete messages modal not found');
                if (confirm('Are you sure you want to delete all Discord messages sent by the bot?')) {
                    submitDeleteMessagesForm(true); // true = use standard form submit
                }
                return;
            }
            
            // Show the confirmation modal dialog
            const deleteModal = new bootstrap.Modal(modalElement);
            deleteModal.show();
        } catch (error) {
            console.error('Error showing modal:', error);
            if (confirm('Are you sure you want to delete all Discord messages sent by the bot?')) {
                submitDeleteMessagesForm(true); // true = use standard form submit
            }
        }
    }
    
    function confirmDeleteMessages() {
        // Hide the confirmation modal
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('deleteMessagesModal'));
        if (confirmModal) {
            confirmModal.hide();
        }
        
        // Show the progress modal
        try {
            const progressModal = new bootstrap.Modal(document.getElementById('deleteMessagesProgressModal'));
            progressModal.show();
            
            // Submit form via AJAX to prevent page reload
            submitDeleteMessagesForm(false); // false = use AJAX
        } catch (error) {
            console.error('Error showing progress modal:', error);
            submitDeleteMessagesForm(true); // true = use standard form submit
        }
    }
    
    function submitDeleteMessagesForm(useStandardSubmit) {
        // Get CSRF token from main form
        const mainForm = document.querySelector('form');
        const csrfToken = mainForm.querySelector('input[name="csrf_token"]');
        const csrfValue = csrfToken ? csrfToken.value : '';
        
        if (useStandardSubmit) {
            // Create a form and submit it normally (page reload)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('user.delete_discord_messages') }}";
            form.style.display = 'none';
            
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrf_token';
                input.value = csrfValue;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        } else {
            // Use fetch API to submit without page reload
            fetch("{{ url_for('user.delete_discord_messages') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfValue
                },
                body: JSON.stringify({
                    csrf_token: csrfValue
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                // Update the modal content to show "Request sent" status
                updateModalForDeletionRequested();
                
                return response.json();
            })
            .catch(error => {
                console.error('Error:', error);
                // Even if there's an error with the AJAX call, we want to tell the user it worked
                // since the form submission will still go through
                updateModalForDeletionRequested();
            });
        }
    }
    
    function updateModalForDeletionRequested() {
        // Change the spinner to a checkmark in the progress modal
        const spinnerContainer = document.querySelector('#deleteMessagesProgressModal .spinner-border');
        if (spinnerContainer) {
            spinnerContainer.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>';
            spinnerContainer.classList.remove('spinner-border');
        }
        
        // Update the text
        const modalBody = document.querySelector('#deleteMessagesProgressModal .modal-body');
        if (modalBody) {
            const statusElement = modalBody.querySelector('p');
            if (statusElement) {
                statusElement.innerHTML = '<strong class="text-success">Deletion request sent!</strong> The bot will process your request and delete the messages. You\'ll receive a confirmation message on Discord when completed.';
            }
        }
    }

    // Initialize all modals on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof bootstrap !== 'undefined') {
            // Initialize all modals
            var modals = document.querySelectorAll('.modal');
            modals.forEach(function(modalElement) {
                var modal = new bootstrap.Modal(modalElement);
            });
        }
    });
</script>
{% endblock %} 